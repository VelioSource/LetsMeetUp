<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Let's Meet Up! | Questionnaire</title>
    <link href="questionnaire.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  </head>

  <header>
    <h1>Let's Meet Up!</h1>
  </header>

  <div class="container">
    <form id="questionnaireForm" action="mainpage.html">
      <div class="step active">
        <h2>Let's Find Yor Perfect Connections</h2>
        <p class="step-title">Step 1: Select your interests <span style="font-size:14px; color:#888;">(select at least one)</span></p>
        <div class="interests-grid">
          <label><input type="checkbox" name="interest" value="Reading"> Reading</label>
          <label><input type="checkbox" name="interest" value="Art"> Art</label>
          <label><input type="checkbox" name="interest" value="Gaming"> Gaming</label>
          <label><input type="checkbox" name="interest" value="Dancing"> Dancing</label>
          <label><input type="checkbox" name="interest" value="Sports"> Sports</label>
          <label><input type="checkbox" name="interest" value="Cooking"> Cooking</label>
          <label><input type="checkbox" name="interest" value="Movies"> Movies</label>
          <label><input type="checkbox" name="interest" value="Gardening"> Gardening</label>
          <label><input type="checkbox" name="interest" value="Music"> Music</label>
          <label><input type="checkbox" name="interest" value="Travel"> Travel</label>
          <label><input type="checkbox" name="interest" value="Photography"> Photography</label>
          <label><input type="checkbox" name="interest" value="Hiking"> Hiking</label>
          <label><input type="checkbox" name="interest" value="Tea Parties"> Tea Parties</label>
          <label><input type="checkbox" name="interest" value="Adventures"> Adventures</label>
          <label><input type="checkbox" name="interest" value="Night Life"> Night Life</label>
      </div>
    </div>

      <div class="step">
        <label for="nationality">What's your nationality?</label>
        <input type="text" id="nationality" name="nationality" required placeholder="e.g. Italian">
      </div>

      <div class="step">
        <h2>Where do you live? <span class="optional-label">(Optional)</span></h2>
        <p class="helper-text">This helps us connect you with people near you.</p>
        <input type="text" id="countryInput" class="country-input" placeholder="Enter your country (optional)" />
      </div>

      <div class="step">
        <h2>How would you describe your sociability?</h2>
        <div class="sociability-options">
          <label><input type="radio" name="sociability" value="Extroverted" required> Extroverted</label>
          <label><input type="radio" name="sociability" value="Introverted" required> Introverted</label>
        </div>
      </div>

      <div class="step">
        <label for="purpose">Why did you join Let's Meet Up?</label>
        <select id="purpose" name="purpose" required>
          <option value="">Select one</option>
          <option value="make_friends">To make new friends</option>
          <option value="practice_language">To practice a language</option>
          <option value="find_events">To find events & meetups</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="buttons">
        <button type="button" class="btn" id="prevBtn" disabled>Back</button>
        <button type="button" class="btn" id="nextBtn">Next</button>
      </div>

    </form>
  </div>

<script>
  const steps = document.querySelectorAll('.step');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const form = document.getElementById('questionnaireForm');
  let currentStep = 0;

  function showStep(step) {
    steps.forEach((s, i) => {
      s.classList.toggle('active', i === step);
    });
    prevBtn.disabled = step === 0;
    nextBtn.textContent = step === steps.length - 1 ? 'Submit' : 'Next';
  }

  function validateStep(step) {
    if (step === 0) {
      const checked = form.querySelectorAll('input[name="interest"]:checked');
      if (checked.length === 0) {
        alert("Please select at least one interest.");
        return false;
      }
    }

    const requiredInputs = steps[step].querySelectorAll('input[required], select[required]');
    for (let input of requiredInputs) {
      if (input.type === 'radio') {
        const radios = form.querySelectorAll(`input[name="${input.name}"]`);
        const isChecked = Array.from(radios).some(r => r.checked);
        if (!isChecked) {
          alert("Please select an option.");
          return false;
        }
      } else if (!input.value) {
        alert("Please fill in the required fields.");
        return false;
      }
    }

    return true;
  }

  nextBtn.addEventListener('click', () => {
    if (currentStep < steps.length - 1) {
      if (validateStep(currentStep)) {
        currentStep++;
        showStep(currentStep);
      }
    } else {
      if (validateStep(currentStep)) {
        const formData = new FormData(form);
        const data = {
          data_type: "questionnaire",
          interests: [...formData.getAll("interest")],
          nationality: formData.get("nationality"),
          location: formData.get("country") || document.getElementById("countryInput").value,
          sociability: formData.get("sociability"),
          purpose: formData.get("purpose"),
        };

        fetch("../../api.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(response => {
          if (response.data_type === "info") {
            window.location.href = "mainpage.html";
          } else {
            alert("Error: " + response.message);
          }
        })
        .catch(err => {
          alert("Network error: " + err.message);
        });
      }
    }
  });

  prevBtn.addEventListener('click', () => {
    if (currentStep > 0) {
      currentStep--;
      showStep(currentStep);
    }
  });

  showStep(currentStep);
</script>

</body>
</html>